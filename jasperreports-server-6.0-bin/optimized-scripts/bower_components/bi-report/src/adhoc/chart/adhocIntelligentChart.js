define(["require","exports","module","jquery","jquery.ui","underscore","prototype","utils.common","designer.base","highcharts","adhoc/chart/adhocToHighchartsAdapter","adhoc/chart/adhocDataProcessor","adhoc/chart/highchartsDataMapper","adhoc/chart/formattingDialog/model/FormattingDialogModel","adhoc/chart/formattingDialog/view/FormattingDialogView","logger"],function(e,t,r){e("jquery"),e("jquery.ui"),e("underscore"),e("prototype"),e("utils.common"),e("designer.base");var n=e("highcharts"),i=e("adhoc/chart/adhocToHighchartsAdapter"),a=e("adhoc/chart/adhocDataProcessor"),s=e("adhoc/chart/highchartsDataMapper"),o=e("adhoc/chart/formattingDialog/model/FormattingDialogModel"),l=e("adhoc/chart/formattingDialog/view/FormattingDialogView"),c=e("logger").register(r),d={},u=d;return _.extend(u,{debug:!1,mode:null,controller:"ich",state:{},cache:[],initd:!1,hasAllData:!1,groupLevel:{column:0,row:0},firstRendering:!0,chartContainerSelector:"#chartContainer",reset:function(){u.isDesignerInitialized=!1},setMode:function(e){this.mode=e},getMode:function(){return this.mode},flush:function(){this.hasAllData=!1,this.cache=[]},setUp:function(){},isOLAP:function(){return this.getMode()===designerBase.OLAP_ICHART},isOlapMode:function(){return this.getMode()===designerBase.OLAP_ICHART},isNonOlapMode:function(){return this.getMode()===designerBase.ICHART},update:function(e){try{u.setUp(),_.extend(this.state,e)}catch(t){u.debug&&console.log("AIC.update:   caught error "+t+" restore state to previous"),adhocDesigner.undo(),dialogs.systemConfirm.show("The previous request encountered an error '"+t+"' restoring chart to previous state")}return this},render:function(){var e=u.state.queryData.data.length>0;return jQuery("#nothingToDisplayMessage").html(adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_DATA")),adhocDesigner.setNothingToDisplayVisibility(!e),u.chart&&u.state.isRedrawRequired===!0&&(u.chart.destroy(),u.chart=void 0),u.ui.update(u.state),u.ui.render(),e=u.renderChart(e),u.isDesignerInitialized=!0,jQuery("[action='chart-format']").removeClass("disabled"),e},renderChart:function(e){if(!u.firstRendering&&u.state.queryData.data.length)if(u.debug&&console.info(u.state),u.state.queryData.metadata.canRender===!1){var t,r=u.state.chartState.chartType;t=u._isTimeSeries()&&!s.isHeatMapTimeSeriesChart(r)?adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_TIME_SERIES_DATA"):s.isDualOrMultiAxisChart(r)||s.isScatterChart(r)||s.isBubbleChart(r)?adhocDesigner.messages["ADH_1214_ICHARTS_NO_DATA_"+r.toUpperCase()]:s.isDualLevelPieChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_DUAL_LEVEL_PIE:s.isHeatMapChart(r)&&!adhocDesigner.isOlapMode()?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_NON_OLAP:s.isHeatMapChart(r)&&adhocDesigner.isOlapMode()?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_HEAT_MAP_OLAP:s.isHeatMapTimeSeriesChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_TIME_SERIES_HEAT_MAP:s.isSpeedometerChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_SPEEDOMETER:s.isArcGaugeChart(r)?adhocDesigner.messages.ADH_1214_ICHARTS_NO_DATA_GAUGE:"Unknown chart type group.",jQuery("#nothingToDisplayMessage").html(t),adhocDesigner.setNothingToDisplayVisibility(!0),u.chart&&(u.chart.destroy(),u.chart=void 0)}else{var o=jQuery(u.chartContainerSelector);u.ichWidth=o.width(),u.ichHeight=o.height();var l=i.generateOptions(u.state.queryData,u.state.chartState,{width:u.ichWidth,height:u.ichHeight,messages:adhocDesigner.messages});if(u._checkHasData(l)){if(e=!0,u.state.isRedrawRequired===!0||!u.chart){u._setAutoScaleFonts();try{u.chart=new n.Chart(l)}catch(d){c.error(d),t=/\#19/.test(d)?adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_TOO_MANY_VALUES:adhocDesigner.messages.ADH_1214_ICHARTS_ERROR_UNCAUGHT,_.each(n.charts,function(e){e&&e.destroy()}),u.state.canSave=!1,adhocDesigner.enableRunAndSave(!1),jQuery("#nothingToDisplayMessage").html(t),adhocDesigner.setNothingToDisplayVisibility(!0),u.chart&&(u.chart.destroy(),u.chart=void 0),e=!1}}}else e=!1,jQuery("#nothingToDisplayMessage").html(adhocDesigner.getMessage("ADH_1214_ICHARTS_NO_CHART_DATA")),adhocDesigner.setNothingToDisplayVisibility(!e);u.isOLAP()&&(u.state.olapDimensionInfo=a.getOLAPDimensionInfo()),isDesignView&&u._renderDataLevelSelector()}return e},redraw:function(){var e=jQuery(u.chartContainerSelector);if(u.ichWidth!=e.width()||u.ichHeight!=e.height()){var t=u.ichHeight==e.height();u.ichWidth=e.width(),u.ichHeight=e.height(),u._setAutoScaleFonts()?u.render():u.chart.setSize(u.ichWidth,u.ichHeight,t)}},_setAutoScaleFonts:function(){var e=jQuery(u.chartContainerSelector);if(!u.state.chartState.autoScaleFonts)return"undefined"!=typeof u.autoScaleFontsSize&&e.css("font-size",u.autoScaleFontsSize),!1;"undefined"==typeof u.autoScaleFontsSize&&(u.autoScaleFontsSize=parseInt(e.css("font-size")));var t=1;return u.ichWidth<=100?t=.4:u.ichWidth>100&&u.ichWidth<=200?t=.5:u.ichWidth>200&&u.ichWidth<=300?t=.6:u.ichWidth>300&&u.ichWidth<=400?t=.7:u.ichWidth>400&&u.ichWidth<=500?t=.8:u.ichWidth>500&&u.ichWidth<=600&&(t=.9),parseInt(e.css("font-size"))!==Math.round(u.autoScaleFontsSize*t)?(e.css("font-size",u.autoScaleFontsSize*t),!0):!1},_isTimeSeries:function(){return-1!=u.state.chartState.chartType.indexOf("time_series")},_isTimeSeriesHeatMap:function(){return s.isHeatMapTimeSeriesChart(u.state.chartState.chartType)},cleanupOnSwitch:function(){u.ui.controls.chartTypeSelector.hide(),u.ui.dialogs.groupSelector.hide()},resize:function(){("pie"==u.state.chartState.chartType||s.isHeatMapTimeSeriesChart(u.state.chartState.chartType))&&u.render()},fixFirstRendering:function(){u.firstRendering&&(u.firstRendering=!1,u.renderChart())},initAll:function(){},_checkHasData:function(e){if(!e)return!1;if(!e.series)return!1;if(e.series.length<=0)return!1;for(var t=!1,r=0;r<e.series.length;r++)if(null!=e.series[r].data&&e.series[r].data.length>0){t=!0;break}return t},_isPivotAllowed:function(){var e=u;return e.getDimensions("row").length>0||e.isOLAP()&&e.getDimensions("column").length>0},_renderDataLevelSelector:function(){var e=u.ui.controls.dataLevelSelector;e.render(),u._isTimeSeries()&&e.hideRowsSlider()}}),_.extend(u,{serviceBus:{_listenersMap:{},_allEventsListeners:[],_incorrectEventTypeMsg:"Service bus supports only string events. Received event is not a string.",fireEvent:function(e){var t=u.serviceBus;if("string"!=typeof e)throw t._incorrectEventTypeMsg;var r=t._listenersMap,n=r[e];n&&_.each(n,function(t){t(e)}),_.each(t._allEventsListeners,function(t){t(e)})},registerListener:function(e,t){var r=u.serviceBus;if("string"!=typeof e)throw r._incorrectEventTypeMsg;var n=r._listenersMap,i=n[e];i||(i=[],n[e]=i),i.push(t)},registerAllEventsListener:function(e){u.serviceBus._allEventsListeners.push(e)}}}),_.extend(u,{mediator:{_isListenerRegistered:!1,eventToAction:{"chart:typeChanged":function(){u.state.chartState.chartType=u.ui.controls.chartTypeSelector.getType(),u.updateChartState()},"chart:levelChanged":function(){u.state.chartState.columnsSelectedLevels=u.ui.controls.dataLevelSelector.getColumnSelectedLevels(),u.state.chartState.rowsSelectedLevels=u.ui.controls.dataLevelSelector.getRowsSelectedLevels(),u.updateChartState()}},listener:function(e){if("string"!=typeof e)throw"Mediator supports only string events. Received event is not a string.";var t=u.mediator.eventToAction[e];t&&t()},register:function(){u.serviceBus._isListenerRegistered||(u.serviceBus.registerAllEventsListener(u.mediator.listener),u.serviceBus._isListenerRegistered=!0)}}}),_.extend(u,{ui:{controls:{dataLevelSelector:{_container:null,_column:null,_row:null,init:function(){var e=u.ui.controls.dataLevelSelector;e._container=jQuery("#dataLevelSelector")},render:function(){if(s.isDualLevelPieChart(u.state.chartState.chartType))return void u.ui.controls.dataLevelSelector.hide();var e=u.ui.controls.dataLevelSelector;u.ui.selectorTables.column.show().find("td.select-header").parent().siblings().remove(),u.ui.selectorTables.row.show().find("td.select-header").parent().siblings().remove(),u.isOLAP()?e._renderOlapSlider():e._renderNonOlapSliders(),adhocDesigner.resetFilterPanelState()},_renderOlapSlider:function(){var e=u.ui.controls.dataLevelSelector;e._column=[],e._row=[],jQuery.each(["row","column"],function(t,r){u.state.olapDimensionInfo[t].length?(jQuery.each(u.state.olapDimensionInfo[t],function(t,n){var i=u.state.chartState[r+"sSelectedLevels"][t];e["_"+r].push(u.ui.create.slider(u.ui.selectorTables[r],n.levels,n.dimension,{max:n.levels.length-1,value:e._levelToLevelPosition(i,n),stop:function(){u.serviceBus.fireEvent("chart:levelChanged")}}))}),u.ui.selectorTables[r].show()):u.ui.selectorTables[r].hide()})},_renderNonOlapSliders:function(){var e=u.ui.controls.dataLevelSelector;e._row=e._renderNonOlapSlider(0),e._column=e._renderNonOlapSlider(1)},_renderNonOlapSlider:function(e){var t=u.ui.controls.dataLevelSelector,r=[];jQuery.each(u.state.queryData.metadata.axes[e],function(e,t){"Measures"!=t.name&&r.push(t.label)});var n=0==e?u.ui.selectorTables.row:u.ui.selectorTables.column,i=0==e?a.getRowSliderLevelCount():a.getColumnSliderLevelCount(),s=0==e?u.state.chartState.rowsSelectedLevels:u.state.chartState.columnsSelectedLevels;return n.find("td.select-header").parent().siblings().remove(),1==i?n.hide():n.show(),u.ui.create.slider(n,r,"",{max:i-1,value:t._getSliderPositionForNonOlap(s,e),stop:function(){u.serviceBus.fireEvent("chart:levelChanged")}})},hide:function(){u.ui.selectorTables.column.hide(),u.ui.selectorTables.row.hide()},hideRowsSlider:function(){u.ui.selectorTables.row.hide()},hideColumnsSlider:function(){u.ui.selectorTables.column.hide()},_levelToLevelPosition:function(e,t){for(var r=0;r<t.levels.length;r++)if(t.levels[r].levelName===e.name)return r;throw"No OLAP level info found for specified level = "+e},getRowsSelectedLevels:function(){var e=u.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._row,e._row,0)},getColumnSelectedLevels:function(){var e=u.ui.controls.dataLevelSelector;return e._getSelectedLevels(e._column,e._column,1)},_getSelectedLevels:function(e,t,r){var n=u.ui.controls.dataLevelSelector;return u.isOLAP()?n._extractOlapSelectedLevels(t,r):n._extractNonOlapSelectedLevels(e,r)},_extractOlapSelectedLevels:function(e,t){var r=u.ui.controls.dataLevelSelector,n=[];return jQuery(e).each(function(e){var i=r._extractSliderPosition(jQuery(this)),a=u.state.olapDimensionInfo[t][e],s=a.levels[i];n.push({name:s.levelName,label:s.label,dimension:a.dimension})}),n},_extractNonOlapSelectedLevels:function(e,t){var r=u.ui.controls.dataLevelSelector,n=r._extractSliderPosition(e);if(0===n)return[];var i=a.getLevelsWithoutMeasures(u.state.queryData.metadata.axes[t]);return[i[n-1]]},_getSliderPositionForNonOlap:function(e,t){if(0==e)return 0;var r=a.getLevelsWithoutMeasures(u.state.queryData.metadata.axes[t]);return a.getLevelIndex(r,e[0])+1},_extractSliderPosition:function(e){return e.slider("option","value")},dock:function(){var e=u.ui.controls.dataLevelSelector;e._container.find("div.pod-body").eq(0).appendTo(jQuery("#level-container")),dialogs.popup.hide(e._container[0])},undock:function(){var e=u.ui.controls.dataLevelSelector;jQuery("#level-container").children("div.pod-body").eq(0).appendTo(e._container.find("div.body").eq(0)),dialogs.popup.show(e._container[0])}},chartTypeSelector:{_type:null,_container:null,_DISABLED_CLASS:"disabled",_patternsDisabledForOlap:["[name$='_time_series']"],init:function(){var e=u.ui.controls.chartTypeSelector;if(e._container=jQuery("#chartTypeSelector"),e._container.on("click","div.cell",e._typeSelectedHandler),u.isOLAP())for(var t=0;t<e._patternsDisabledForOlap.length;t++)jQuery(e._patternsDisabledForOlap[t]).addClass(e._DISABLED_CLASS)},update:function(e){var t=u.ui.controls.chartTypeSelector;t._type=e},render:function(){var e=u.ui.controls.chartTypeSelector;e._container.find("div.cell").removeClass("selected"),e._container.find('div.cell[name="'+e._type+'"]').eq(0).addClass("selected")},hide:function(){var e=u.ui.controls.chartTypeSelector;dialogs.popup.hide(e._container[0])},_typeSelectedHandler:function(){var e=u.ui.controls.chartTypeSelector;jQuery(this).hasClass(e._DISABLED_CLASS)||(e._type=this.getAttribute("name"),e.render(),u.serviceBus.fireEvent("chart:typeChanged"))},getType:function(){var e=u.ui.controls.chartTypeSelector;return e._type}}},update:function(e){u.ui.controls.chartTypeSelector.update(e.chartState.chartType)},render:function(){var e=jQuery("#titleCaption");u.state.titleBarShowing?e.show():e.hide(),e.html(u.state.title),adhocDesigner.enableXtabPivot(u._isPivotAllowed()),u.ui.controls.chartTypeSelector.render(),u.ui.dialogs.formatDialog.model.set(u.state.chartState),u.ui.controls.dataLevelSelector.hide()},create:{sliderTable:function(e){var t=jQuery("#level-container").show().children(".pod-body").eq(0),r=Mustache.to_html(jQuery("#levelSelectorTemplate").html(),{id:(e?"row":"column")+"LevelSelector",colspan:u.isOLAP()?2:1,name:e?layoutManagerLabels.row[u.mode]:layoutManagerLabels.column[u.mode]}),n=jQuery(r).appendTo(t);return n.on("mouseover","div.tickOverlay",function(){var e=jQuery(this).parent();u.dataLevelTooltip.html(e.attr("level-name")),u.dataLevelTooltip.show().position({of:e,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==u.ui.selectorTables.column.css("display")&&u.ui.selectorTables.column.hide().show(),"block"==u.ui.selectorTables.row.css("display")&&u.ui.selectorTables.row.hide().show()}),n.on("mouseover","a.ui-slider-handle",function(){var e=jQuery(this).parent(),t=e.children("div.sliderTick").eq(e.slider("option","value"));u.dataLevelTooltip.html(t.attr("level-name")),u.dataLevelTooltip.show().position({of:t,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==u.ui.selectorTables.column.css("display")&&u.ui.selectorTables.column.hide().show(),"block"==u.ui.selectorTables.row.css("display")&&u.ui.selectorTables.row.hide().show()}),n.on("mouseout","a.ui-slider-handle, div.tickOverlay",function(){u.dataLevelTooltip.hide(),"block"==u.ui.selectorTables.column.css("display")&&u.ui.selectorTables.column.hide().show(),"block"==u.ui.selectorTables.row.css("display")&&u.ui.selectorTables.row.hide().show()}),n},slider:function(e,t,r,n){var i={label:u.isOLAP()?{name:r}:!1,marginLeft:u.isOLAP()?"24px":0};e.find("tbody").eq(0).append(Mustache.to_html(jQuery("#dataLevelSelectorTemplate").html(),i));var a=e.find("div.jrs-slider").last();a.slider({value:n.value,min:0,max:n.max,step:1,range:"min",stop:n.stop,slide:function(e,t){var r=jQuery(t.handle).parent().children("div.sliderTick").eq(t.value);u.dataLevelTooltip.html(r.attr("level-name")),u.dataLevelTooltip.show().position({of:r,at:"center top",my:"center bottom",offset:"0 -6",collision:"fit"}),"block"==u.ui.selectorTables.column.css("display")&&u.ui.selectorTables.column.hide().show(),"block"==u.ui.selectorTables.row.css("display")&&u.ui.selectorTables.row.hide().show()}});var s=n.max>0?100/n.max:0;u.isOLAP()||(t.unshift("All"),n.max++);for(var o=0;o<n.max+1;o++)if(t[o]){var i={label:t[o].label||t[o],width:o*s};"All"==i.label&&(i.label="Total");var l=Mustache.to_html(jQuery("#sliderTickTemplate").html(),i);a.append(l)}return a}}},init:function(){if(u.mediator.register(),u.dataLevelTooltip=jQuery("#dataLevelTooltip"),jQuery("#chartOptions").appendTo(adhocDesigner.ui.canvas).show(),jQuery("#chartMenu").appendTo(adhocDesigner.ui.canvas),jQuery(Mustache.to_html(jQuery("#titleCaptionTemplate").html()),{}).appendTo(adhocDesigner.ui.canvas).show(),jQuery("#chartContainer").appendTo(adhocDesigner.ui.canvas).show(),!u.initd&&(jQuery("#chartOptions").on("mouseenter",function(){jQuery(this).addClass("over"),jQuery("#chartMenu").show().position({of:jQuery("#chartOptions"),at:"left bottom",my:"left top",offset:"0 -1"})}),jQuery("#chartMenu").on("mouseleave",function(){jQuery("#chartOptions").removeClass("over"),jQuery("#chartMenu").hide()}),jQuery("#chartMenu").on("mouseenter","p.wrap",function(){jQuery(this).addClass("over")}),jQuery("#chartMenu").on("mouseleave","p.wrap",function(){jQuery(this).removeClass("over")}),jQuery("#chartMenu").on("click","li",function(){if(jQuery(this).is('[action="chart-types"]'))dialogs.popup.show(u.ui.dialogs.typeSelector[0]),u.ui.controls.chartTypeSelector.render();else if(jQuery(this).is('[action="chart-format"]')){if(jQuery(this).hasClass("disabled"))return;u.ui.dialogs.formatDialog.model.set(u.state.chartState),dialogs.popup.show(u.ui.dialogs.formatDialog.el),adhocDesigner.initEnableBrowserSelection($("designer"))}}),jQuery("#chartTypeSelector .closeIcon").on(isIPad()?"touchstart":"click",function(){u.ui.dialogs.typeSelector.hide()}),jQuery("#dataLevelSelector .closeIcon").on(isIPad()?"touchstart":"click",function(){u.ui.dialogs.groupSelector.hide()}),u.ui.dialogs={typeSelector:jQuery("#chartTypeSelector"),groupSelector:jQuery("#dataLevelSelector")},u.ui.selectorTables={column:u.ui.create.sliderTable(!1),row:u.ui.create.sliderTable(!0)},u.ui.controls.chartTypeSelector.init(),u.ui.controls.dataLevelSelector.init(),!u.ui.dialogs.formatDialog)){var e=new o(u.state.chartState,{parse:!0,updateState:_.bind(u.updateChartState,u)});u.ui.dialogs.formatDialog=new l({model:e})}u.ui.dialogs.typeSelector.hide(),u.ui.dialogs.groupSelector.hide(),jQuery("#level-container").show(),u.initd=!0},hide:function(){jQuery("#chartOptions").appendTo("#highChartsRepo").hide(),jQuery("#chartMenu").appendTo("#highChartsRepo").hide(),jQuery("#titleCaption").remove(),jQuery("#chartContainer").appendTo("#highChartsRepo").hide()}}),_.extend(u,{mouseUpHandler:function(){},mouseDownHandler:function(){},mouseOverHandler:function(){},mouseOutHandler:function(){},mouseClickHandler:function(){},treeMenuHandler:function(e){var t,r=e.memo.node;"dimensionsTree"===r.treeId?t=r.isParent()?adhocDesigner.DIMENSION_TREE_DIMENSION_CONTEXT:adhocDesigner.DIMENSION_TREE_LEVEL_CONTEXT:"measuresTree"===r.treeId&&(t=r.isParent()?adhocDesigner.MEASURE_TREE_GROUP_CONTEXT:adhocDesigner.MEASURE_TREE_CONTEXT),adhocDesigner.showDynamicMenu(e.memo.targetEvent,t,null)},lmHandlersMap:{addItems:function(e,t,r){var n=_.map(e,function(e){return e.extra.dimensionId});u.insertDimensionInAxisWithChild({dim:e[0].extra.isMeasure?n.slice(0,1):n,axis:r,pos:t,child:_.pluck(e,"id"),hierarchyName:e[0].extra.hierarchyName})},measureReorder:function(e,t){u.moveMeasure(e,t)},column:{addItem:function(e,t,r,n,i,a,s){u.insertDimensionInAxisWithChild({dim:e,axis:"column",pos:t,child:r,measure_pos:n,isMeasure:i,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?u.removeMeasure(t):u.hideColumnLevel(e.dimensionId,e.level)},moveItem:function(e,t,r){u.moveDimension(e,"column",r)},switchItem:function(e,t,r){u.moveDimension(e,"column",r)},contextMenu:function(e,t){u.selectFromDisplayManager(t.targetEvent,t.extra,designerBase.COLUMN_GROUP_MENU_LEVEL),actionModel.setSelected([t.extra]),u.showMenu(t.targetEvent,"displayManagerColumn")}},row:{addItem:function(e,t,r,n,i,a,s){u.insertDimensionInAxisWithChild({dim:e,axis:"row",pos:t,child:r,measure_pos:n,isMeasure:i,uri:a,hierarchyName:s})},removeItem:function(e,t){e.isMeasure?u.removeMeasure(t):u.hideRowLevel(e.dimensionId,e.level)},moveItem:function(e,t,r){u.moveDimension(e,"row",r)},switchItem:function(e,t,r){u.moveDimension(e,"row",r)},contextMenu:function(e,t){u.selectFromDisplayManager(t.targetEvent,t.extra,designerBase.ROW_GROUP_MENU_LEVEL),actionModel.setSelected([t.extra]),u.showMenu(t.targetEvent,"displayManagerRow")}}}}),_.extend(u,{insertDimensionInAxisWithChild:function(e){u.flush(),designerBase.sendRequest("ich_insertDimensionInAxisWithChild",e,adhocDesigner.render,{bPost:!0})},removeMeasure:function(e){designerBase.sendRequest("ich_removeMeasure",new Array("i="+e),adhocDesigner.render,null)},moveDimension:function(e,t,r){designerBase.sendRequest("ich_moveDimension",new Array("dim="+encodeText(e),"axis="+t,"pos="+r),adhocDesigner.render,null)},hideRowLevel:function(e,t){designerBase.sendRequest("ich_hideRowLevel",new Array("f="+encodeText(e),"level="+encodeText(t)),adhocDesigner.render,null)},hideColumnLevel:function(e,t){var r=function(r){adhocDesigner.render(r);var n=u.getLevelObject(t,e,"column");n&&n.propertyMap&&"true"==n.propertyMap.lastFilteredLevel&&dialogs.systemConfirm.show(adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3)};designerBase.sendRequest("ich_hideColumnLevel",new Array("f="+encodeText(e),"level="+encodeText(t)),r,null)},expandAllLevels:function(){u.debug&&console.log("AIC.expandAllLevels:  sending expandAll query, this may take some time"),u.cache=[],u.hasAllData=!0,designerBase.sendRequest("ich_expandAllLevels",null,adhocDesigner.render,null)},switchToColumnGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=_.isNumber(e)?e:t.groupIndex;designerBase.sendRequest("ich_switchToColumnGroup",new Array("i="+r),adhocDesigner.render,null)},switchToRowGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=_.isNumber(e)?e:t.groupIndex;designerBase.sendRequest("ich_switchToRowGroup",new Array("i="+r),adhocDesigner.render,null)},moveRowGroup:function(e,t,r){var n=function(e){adhocDesigner.render(e),r&&r()};designerBase.sendRequest("ich_moveRowGroup",new Array("f="+e,"t="+t),n,null)},moveColumnGroup:function(e,t,r){var n=function(e){adhocDesigner.render(e),r&&r()};designerBase.sendRequest("ich_moveColumnGroup",new Array("f="+e,"t="+t),n,null)},moveMeasure:function(e,t){designerBase.sendRequest("ich_moveMeasureByName",["measure="+e,"to="+t],adhocDesigner.render,null)},updateChartState:function(e){jQuery.extend(u.state.chartState,e);var t=function(e){if(!e)throw"No response received on save chart state request";adhocDesigner.render(e)};designerBase.sendRequest("ich_updateChartState",["chartState="+encodeURI(Object.toJSON(u.state.chartState))],t,null)},setCategoryForRowGroup:function(e,t){var r=function(e){adhocDesigner.render(e)};designerBase.sendRequest("ich_setRowGroupCategorizer",new Array("cat="+encodeText(e),"i="+t),r,null)},setCategoryForColumnGroup:function(e,t){var r=function(e){adhocDesigner.render(e)};designerBase.sendRequest("ich_setColumnGroupCategorizer",new Array("cat="+encodeText(e),"i="+t),r,null)},setSummaryFunction:function(e,t){designerBase.sendRequest("ich_setSummaryFunction",new Array("f="+e,"i="+t),u.standardIChartOpCallback,null)},setSummaryFunctionAndMask:function(e,t,r){designerBase.sendRequest("cr_setSummaryFunctionAndDataMask",new Array("f="+e,"m="+encodeText(t),"i="+r),u.standardIChartOpCallback,null)},setHideEmptyRows:function(){designerBase.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=true"),u.standardIChartOpCallback,null)},setUnhideEmptyRows:function(){designerBase.sendRequest("ich_setProperty",new Array("name=hideEmptyRows","value=false"),u.standardIChartOpCallback,null)},updateViewCallback:function(e){localContext.standardIChartOpCallback(e)}}),_.extend(u,{canSaveReport:function(){return u.state.canSave},hideEmptyRowsEquals:function(e){return u.state.crosstabState.hideEmptyRows===e},canAddFilter:function(e,t){var r=localContext.isOlapMode()&&(isNotNullORUndefined(e.isMeasure)?e.isMeasure:e.param.extra&&e.param.extra.isMeasure),n=isNotNullORUndefined(e.param)?e.param.extra&&e.param.extra.id==localContext.ALL_LEVEL_NAME:e.level==localContext.ALL_LEVEL_NAME,i=localContext.isOlapMode()&&localContext._isAddingFilterDuplicate(e);return r?(t&&t.push(addFilterErrorMessageMeasureAdd),!1):n?(t&&t.push(addFilterErrorMessageAllLevelAdd),!1):e.isParent&&e.isParent()?(t&&t.push(addFilterErrorMessageGroupAdd),!1):adhocDesigner.isSpacerSelected(e)?(t&&t.push(addFilterErrorMessageSpacerAdd),!1):adhocDesigner.isPercentOfParentCalcSelected(e)?(t&&t.push(addFilterErrorMessagePercentOfParentCalcFieldAdd),!1):adhocDesigner.isConstantSelected(e)?(t&&t.push(addFilterErrorMessageConstantAdd),!1):i?(t&&t.push(addFilterErrorMessage),!1):!0},canAddSliceFilter:function(){var e=selObjects.find(function(e){return!e.isSliceable});return selObjects.first()&&!e},_isAddingFilterDuplicate:function(e){var t;return t=e.param?"["+e.param.extra.dimensionId+"].["+e.param.extra.id+"]":"["+e.dimensionId+"].["+e.level+"]",adhocDesigner.filtersController.hasFilterForField(t)},isDateType:function(){return u.isDateTimeType("date")},isTimestampType:function(){return u.isDateTimeType("timestamp")},isTimeType:function(){return u.isDateTimeType("time")},isDateTimeType:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();if(t){var r=u.isGroupSelected(t),n=AdHocCrosstab.getSelectedGroup(t);if(n){var i=n.canReBucket===!0,a=n.type===e;return r&&i&&a}}return!1},isGroupSelected:function(e){return!e.isMeasure},isCurrentDateType:function(e){var t=AdHocCrosstab.getSelectedGroup(adhocDesigner.getSelectedColumnOrGroup());return t?t.categorizerName==e:!1},canMoveUpOrLeft:function(){var e=adhocDesigner.getSelectedColumnOrGroup(),t=u.getSelectedDimensionIndex(e);return t>0},canMoveDownOrRight:function(){var e=adhocDesigner.getSelectedColumnOrGroup(),t=u.getSelectedDimensionIndex(e);return t<u.getDimensions(e.axis).length-1},canAddSiblingLevels:function(){return!0},canSwitchToRow:function(){var e=adhocDesigner.getSelectedColumnOrGroup();return!u.isOLAP()||u.getDimensions(e.axis).length>1},canAddDimensionAsRowGroup:function(){var e=selObjects.first();if(e.hasChilds()||(e=e.parent),u.isOLAP()){if(0===u.getDimensions("column").length)return!1;var t=e.param.id,r=e.param.extra.isHierarchy&&e.param.extra.id,n=u.getLevelsFromDimension(t,"column"),i=u.getLevelsFromDimension(t,"row"),a=i.length>0&&i[0].indexOf("["+r+"]")>-1;return 0===n.length&&(e.param.extra.isHierarchy&&!a||i.length<e.getChildCount())}var s=dynamicTree.trees[e.getTreeId()],o=adhocDesigner.getAllLeaves(e,s),l=adhocDesigner.getAllLeaves(e,s).collect(function(e){return e.param.extra.id});if(o[0].param.extra.isMeasure){var c=u.getFilteredMeasureList("column");return 0===c.length}var d=_.pluck(u.getFilteredList(),"name");return _.difference(l,d).length>0},canAddDimensionAsColumnGroup:function(){var e=selObjects.first();if(e.hasChilds()||(e=e.parent),u.isOLAP()){var t=e.param.id,r=e.param.extra.isHierarchy&&e.param.extra.id,n=u.getLevelsFromDimension(t,"column"),i=u.getLevelsFromDimension(t,"row"),a=n.length>0&&n[0].indexOf("["+r+"]")>-1;return 0===i.length&&(e.param.extra.isHierarchy&&!a||n.length<e.getChildCount())}var s=dynamicTree.trees[e.getTreeId()],o=adhocDesigner.getAllLeaves(e,s),l=adhocDesigner.getAllLeaves(e,s).collect(function(e){return e.param.extra.id});if(o[0].param.extra.isMeasure){var c=u.getFilteredMeasureList("row");return 0===c.length}var d=_.pluck(u.getFilteredList(),"name");return _.difference(l,d).length>0},canAddLevelAsColumnGroup:function(){var e=selObjects.first(),t=u.isOLAP()?[e.param.extra.dimensionId]:adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId}),r=t.inject([],function(e,t){return e.concat(u.getLevelsFromDimension(t,"column")||[])}),n=t.inject([],function(e,t){return e.concat(u.getLevelsFromDimension(t,"row")||[])});return 0===n.length&&(0===r.length||!u.isOLAP()&&e.param.extra.isMeasure||!r.find(function(e){return _.contains(_.map(designerBase.getSelectedObjects(),function(e){return e.param.extra.id}),e)}))},canAddLevelAsRowGroup:function(){if(0===u.getDimensions("column").length&&u.isOLAP())return!1;var e=selObjects.first(),t=u.isOLAP()?[e.param.extra.dimensionId]:adhocDesigner.getAllLeaves(e).map(function(e){return e.param.extra.dimensionId}),r=t.inject([],function(e,t){return e.concat(u.getLevelsFromDimension(t,"column")||[])}),n=t.inject([],function(e,t){return e.concat(u.getLevelsFromDimension(t,"row")||[])});return 0===r.length&&(0===n.length||!u.isOLAP()&&e.param.extra.isMeasure||!n.find(function(t){return e.param.extra.id===t}))},isRowGroupSelected:function(e){return"row"===e.axis&&!e.isMeasure},isColumnGroupSelected:function(e){return"column"===e.axis&&!e.isMeasure},showAddHierarchyConfirm:function(e,t,r){return u.fromSiblingHierarchy(e,t)?(adhocDesigner.addConfirmDialog.show({ok:function(){return u.isFiltersApplied(t)?void dialogs.systemConfirm.show(adhocDesigner.getMessage("ADH_CROSSTAB_LAST_FILTERED_LEVEL"),5e3):void r()}}),!0):!1},isFiltersApplied:function(e,t){var r=_.pluck(u.getLevelObjectsFromDimension(e,t),"levelUniqueName"),n=_.pluck(u.state.existingFilters,"name");return!_.isEmpty(_.intersection(r,n))}}),_.extend(u,{removeLevelFromColumn:function(){var e=selObjects.first();jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"column",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},removeLevelFromRow:function(){var e=selObjects.first();jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:removeItem",{axis:"row",index:e.index,item:{level:e.level,dimensionId:e.dimensionId,isMeasure:e.isMeasure}})},moveRowGroupLeft:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=u.getSelectedDimensionIndex(t),n=r-1;u.moveRowGroup(r,n,e)},moveRowGroupRight:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=u.getSelectedDimensionIndex(t),n=r+1;u.moveRowGroup(r,n,e)},moveColumnGroupLeft:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=u.getSelectedDimensionIndex(t),n=r-1;u.moveColumnGroup(r,n,e)},moveColumnGroupRight:function(e){var t=adhocDesigner.getSelectedColumnOrGroup(),r=u.getSelectedDimensionIndex(t),n=r+1;u.moveColumnGroup(r,n,e)},appendDimensionWithLevel:function(e,t){var r=e?u.getAvailableFieldsNodeBySelection(e.id,e.groupId):u.getAvailableFieldsNodeBySelection();r.axis=t,u.showAddHierarchyConfirm(r.hierarchyName,r.dimensionId,function(){jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",r)})||jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItem",r)},appendDimensionToRowAxisWithLevel:function(e){u.appendDimensionWithLevel(e,"row")},appendDimensionToColumnAxisWithLevel:function(e){u.appendDimensionWithLevel(e,"column")},appendMeasureToRow:function(e){var t=e?u.getAvailableFieldsNodesBySelection(e):u.getAvailableFieldsNodesBySelection();jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"row",levels:t,index:t[0].index})},appendMeasureToColumn:function(e){var t=e?u.getAvailableFieldsNodesBySelection(e):u.getAvailableFieldsNodesBySelection();jQuery("#"+adhocDesigner.DISPLAY_MANAGER_ID).trigger("lm:addItems",{axis:"column",levels:t,index:t[0].index})},showMenu:function(e,t){var r,n=null;switch(t){case"displayManagerRow":r="displayManagerRow",n=u.generateAvailableSummaryCalculationsMenu;break;case"displayManagerColumn":r="displayManagerColumn",n=u.generateAvailableSummaryCalculationsMenu;break;case"groupMember":r=designerBase.MEMBER_GROUP_MENU_LEVEL,n=u.updateContextMenuWithSiblingLevels;break;case"measuresDimensionRow":r="measuresDimensionInRows";break;case"measuresDimensionColumn":r="measuresDimensionInColumns";break;case"rowGroup":r=designerBase.ROW_GROUP_MENU_LEVEL;break;case"columnGroup":r=designerBase.COLUMN_GROUP_MENU_LEVEL;break;case"measureRow":r="measureRow";break;case"measureColumn":r="measureColumn"}adhocDesigner.showDynamicMenu(e,r,null,n)},generateAvailableSummaryCalculationsMenu:function(e,t){if(!actionModel.selObjects[0].isMeasure)return t;var r=_.find(t,function(e){return"AdHocCrosstab.selectedMeasureShowsSummaryOptions"===e.clientTest});if(r){var n=actionModel.selObjects[0],i=_.findWhere(u.state.measures,{name:n.name});i&&adhocDesigner.generateAvailableSummaryCalculationsMenu(i.fieldName,r,{action:d.selectFunction,isSelectedTest:AdHocCrosstab.isSelectedSummaryFunction})}return t},setCatForColumnGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();t&&u.isColumnGroupSelected(t)&&u.setCategoryForColumnGroup(e,t.groupIndex)},setCatForRowGroup:function(e){var t=adhocDesigner.getSelectedColumnOrGroup();t&&u.isRowGroupSelected(t)&&u.setCategoryForRowGroup(e,t.groupIndex)},selectFunction:function(e){var t=AdHocCrosstab.getSelectedMeasure();if(t){var r=selObjects.first().index,n=adhocDesigner.getSuperType(t.type),i=AdHocCrosstab.getMeasureTypeByFunction(e);n!==i?u.setSummaryFunctionAndMask(e,defaultMasks[i],r):u.setSummaryFunction(e,r)
}}}),_.extend(u,{getDimensions:function(e){var t=u.state.crosstabState;return e?t[e+"Groups"]:_.chain(t).filter(function(e,t){return t.search(/Groups$/)>=0}).flatten().value()},getLevelsFromDimension:function(e,t){return _.pluck(this.getLevelObjectsFromDimension(e,t),"name")},getLevelObjectsFromDimension:function(e,t){var r=this.getDimensions(t);return e=_.find(r,function(t){return t.name===e}),e?_.chain(e.levels).filter(function(e){return e.visible}).map(function(e){return _.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return!e.isSpacer}).value():[]},getLevelObject:function(e,t,r){function n(e,t){return _.find(e,function(e){return e.name==t})}var i=this.getDimensions(r),a=n(i,t);return a?n(a.levels,e):null},getFilteredList:function(e,t){var r=e||null,n=t||{};return 1===arguments.length&&_.isObject(e)&&(n=e,r=null),n.visible=!0,_.chain(u.getDimensions(r)).pluck("levels").flatten().map(function(e){return _.isEmpty(e.members)?e:e.members}).flatten().filter(function(e){return _.all(n,function(t,r){return void 0===e[r]||e[r]===t})}).value()},getFilteredMeasureList:function(e,t){var r=e||null,n=t||{};return 1===arguments.length&&_.isObject(e)&&(n=e,r=null),u.getFilteredList(r,_.extend(n,{measure:!0,measuresLevel:!0}))},fromSiblingHierarchy:function(e,t,r){if(!e)return!1;var n=this.getLevelsFromDimension(t,r);return n.length>0&&-1===n[0].indexOf("["+e+"]")},getHierarchy:function(e){var t=e.param.extra;return e.hasChilds()?(e.getFirstChild().hasChilds()&&(t=e.getFirstChild().param.extra),t&&t.isHierarchy?t.id:void 0):t.hierarchyName},getAvailableFieldsNodeBySelection:function(e,t,r){var n={};if(r||(r=selObjects.first()),selectionCategory.area==designerBase.AVAILABLE_FIELDS_AREA)r.hasChilds()?(n.isMeasure="measuresTree"===r.treeId,n.dimensionId=n.isMeasure?r.treeId:r.param.id,n.uri=localContext.isNonOlapMode()?r.param.uri:void 0,n.level=null):(n.isMeasure=!!r.param.extra.isMeasure,n.level=r.param.extra.dimensionId&&r.param.id,n.dimensionId=r.param.extra.dimensionId||r.param.extra.id),n.hierarchyName=this.getHierarchy(r),n.index=-1;else if(selectionCategory.area==designerBase.ROW_GROUP_MENU_LEVEL||selectionCategory.area==designerBase.COLUMN_GROUP_MENU_LEVEL)if(e||t){var i=/.*\[(.*)\]/.exec(e),a=i&&i[1];n.isMeasure=!t,n.level=e,n.dimensionId=n.isMeasure?adhocDesigner.MEASURES:t,n.index=-1,n.hierarchyName=a}else{if(!r.axis)return void alert("Need a way to get dimension name for clicked level from crosstab");n=r}return n},getAvailableFieldsNodesBySelection:function(e,t){for(var r=[],n=0;n<selObjects.length;n++)r.push(u.getAvailableFieldsNodeBySelection(e,t,selObjects[n])),r[n].extra=r[n],r[n].dimensionId=r[n].dimensionId,r[n].id=r[n].level;return r},updateContextMenuWithSiblingLevels:function(e,t){if(!adhocDesigner.ui.display_manager)return t;var r=t.find(function(e){return"AdHocCrosstab.canAddSiblingLevels"===e.clientTest});if(!r)return t;var n=null,i=null,a=null,s=selObjects[0],o=/.*\[(.*)\]/.exec(s.level),l=o&&o[1];if(selObjects.first().isMeasure)i=adhocDesigner.measuresTree.getRootNode(),a="row"===selObjects.first().axis?"AdHocCrosstab.appendMeasureToRow":"AdHocCrosstab.appendMeasureToColumn";else{if(!u.isOLAP())return selObjects.first().index=0,t;i=adhocDesigner.dimensionsTree.getRootNode().childs.find(function(e){return e.param.extra.id===selObjects.first().dimensionId}),i.childs[0].param.extra.isHierarchy&&(i=_.find(i.childs,function(e){return e.param.extra.id===l})),a="row"===selObjects.first().axis?"AdHocCrosstab.appendDimensionToRowAxisWithLevel":"AdHocCrosstab.appendDimensionToColumnAxisWithLevel"}if(void 0===selObjects.first().allLevels){var c=selObjects.first();c.allLevels=AdHocCrosstab.state.getLevelsFromDimension(selObjects.first().dimensionId,c.axis),c.index=c.allLevels.indexOf(c.level)}return selObjects.first().allLevels&&(n=u.isOLAP()?i.childs.findAll(function(e){return!selObjects.first().allLevels.include(e.param.extra.id)}):adhocDesigner.getAllLeaves(i,adhocDesigner.measuresTree).findAll(function(e){return!selObjects.first().allLevels.include(e.param.extra.id)})),n&&0!=n.length?(r.text=adhocDesigner.getMessage(selObjects.first().isMeasure?"addMeasures":"addLevels"),r.children=n.collect(function(e){return actionModel.createMenuElement("optionAction",{text:e.name,action:a,actionArgs:selObjects.first().isMeasure?[e.param.extra.id]:[{id:e.param.extra.id,groupId:e.param.extra.dimensionId,isMeasure:!1}]})}),t):t},getSelectedDimensionIndex:function(e){if(e){var t=e.isMeasure?adhocDesigner.MEASURES:e.dimensionId,r=-1;_.find(u.getDimensions(e.axis),function(e,n){return e.name===t?(r=n,!0):void 0})}return r}}),_.extend(u,{selectFromDisplayManager:function(e,t,r){designerBase.unSelectAll();var n=adhocDesigner.isMultiSelect(e,r);selectionCategory.area=r;var i=adhocDesigner.isAlreadySelected(t);adhocDesigner.addSelectedObject(e,t,n,i),Event.stop(e)},deselectAllSelectedOverlays:function(){}}),_.extend(u,{standardOpCallback:function(e){e?localContext.standardIChartOpCallback(e):window.console&&console.log("Internal server error occurred")},standardIChartOpCallback:function(e){adhocDesigner.render(e)}}),jQuery(window).on("resizeEnd",function(){(localContext.getMode()==designerBase.ICHART||localContext.getMode()==designerBase.OLAP_ICHART)&&localContext.resize()}),jQuery("#designer").bind({"rendering:done":function(){(localContext.getMode()==designerBase.ICHART||localContext.getMode()==designerBase.OLAP_ICHART)&&u.fixFirstRendering()}}),window.AdhocIntelligentChart=d,window.AIC=d,d});